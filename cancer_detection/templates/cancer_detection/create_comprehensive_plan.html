{% extends 'base.html' %}

{% block title %}Create Comprehensive AI-Powered Treatment Plan{% endblock %}

{% block content %}
<div class="fade-in max-w-7xl mx-auto">
    <div class="mb-8 sm:mb-12">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-foreground mb-3">
                    <i class="fas fa-brain text-primary mr-3"></i>Comprehensive AI Treatment Plan
                </h1>
                <p class="text-base sm:text-lg text-muted-foreground max-w-3xl">
                    Integrate all your medical data to generate an intelligent, personalized treatment plan powered by advanced AI
                </p>
            </div>
            <a href="{% url 'cancer_detection:treatment_plans_list' %}" 
               class="btn-secondary hidden sm:inline-flex items-center">
                <i class="fas fa-list mr-2"></i>View Plans
            </a>
        </div>
    </div>

    {% if not has_data %}
    <div class="bg-yellow-500/10 border-2 border-yellow-500/50 rounded-2xl p-8 mb-8">
        <div class="flex items-start gap-4">
            <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 text-3xl"></i>
            <div>
                <h3 class="text-lg font-bold text-yellow-700 dark:text-yellow-300 mb-2">No Data Available</h3>
                <p class="text-yellow-700 dark:text-yellow-300 mb-4">
                    You need to have at least one of the following to create a comprehensive plan:
                </p>
                <ul class="list-disc list-inside text-yellow-700 dark:text-yellow-300 space-y-1 mb-4">
                    <li>Cancer image analysis with tumor detection</li>
                    <li>Histopathology report</li>
                    <li>Genomic profile</li>
                </ul>
                <div class="flex gap-3">
                    <a href="{% url 'cancer_detection:upload' %}" class="btn-primary">
                        <i class="fas fa-image mr-2"></i>Upload Cancer Image
                    </a>
                    <a href="{% url 'cancer_detection:upload_histopathology' %}" class="btn-secondary">
                        <i class="fas fa-file-medical mr-2"></i>Upload Histopathology
                    </a>
                    <a href="{% url 'cancer_detection:upload_genomic_profile' %}" class="btn-secondary">
                        <i class="fas fa-dna mr-2"></i>Upload Genomic Data
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="bg-card border border-border/50 rounded-2xl p-6 sm:p-10 transition-all shadow-lg">
        <form method="post" class="space-y-10" id="comprehensive-plan-form">
            {% csrf_token %}
            
            <!-- Data Sources Selection -->
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-foreground flex items-center">
                        <i class="fas fa-database text-primary mr-3"></i>Select Medical Data Sources
                    </h2>
                    <span class="text-sm text-muted-foreground">Select multiple items for better accuracy</span>
                </div>
                
                <!-- Cancer Image Analyses -->
                {% if analyses %}
                <div class="bg-background/50 rounded-xl p-6 border border-border/30">
                    <h3 class="text-lg font-semibold text-foreground mb-4 flex items-center">
                        <i class="fas fa-image text-blue-500 mr-2"></i>Cancer Image Analyses
                        <span class="ml-auto text-sm font-normal text-muted-foreground">{{ analyses.count }} available</span>
                    </h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for analysis in analyses %}
                        <label class="flex items-start p-4 bg-card hover:bg-accent rounded-lg cursor-pointer border-2 border-transparent hover:border-primary/50 transition-all">
                            <input type="checkbox" name="analyses" value="{{ analysis.id }}" 
                                class="mt-1 mr-3 rounded border-input text-primary focus:ring-primary">
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="font-semibold text-foreground">{{ analysis.tumor_type|default:"Cancer Analysis" }}</p>
                                        <p class="text-sm text-muted-foreground">Stage {{ analysis.tumor_stage|default:"Unknown" }} • {{ analysis.created_at|date:"M d, Y" }}</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-1">
                                        {% if analysis.tumor_detected %}
                                        <span class="px-2 py-1 bg-red-500/20 text-red-600 dark:text-red-400 rounded text-xs font-semibold">
                                            Tumor Detected
                                        </span>
                                        {% endif %}
                                        {% if analysis.detection_confidence %}
                                        <span class="text-xs text-muted-foreground">
                                            {{ analysis.detection_confidence|floatformat:0 }}% confidence
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if analysis.tumor_size_mm %}
                                <p class="text-xs text-muted-foreground mt-1">Size: {{ analysis.tumor_size_mm|floatformat:1 }} mm</p>
                                {% endif %}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Histopathology Reports -->
                {% if histopathology_reports %}
                <div class="bg-background/50 rounded-xl p-6 border border-border/30">
                    <h3 class="text-lg font-semibold text-foreground mb-4 flex items-center">
                        <i class="fas fa-microscope text-green-500 mr-2"></i>Histopathology Reports
                        <span class="ml-auto text-sm font-normal text-muted-foreground">{{ histopathology_reports.count }} available</span>
                    </h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for report in histopathology_reports %}
                        <label class="flex items-start p-4 bg-card hover:bg-accent rounded-lg cursor-pointer border-2 border-transparent hover:border-primary/50 transition-all">
                            <input type="checkbox" name="histopathology_reports" value="{{ report.id }}" 
                                class="mt-1 mr-3 rounded border-input text-primary focus:ring-primary">
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="font-semibold text-foreground">{{ report.cancer_type|default:"Histopathology Report" }}</p>
                                        <p class="text-sm text-muted-foreground">
                                            {% if report.stage %}Stage {{ report.stage }}{% endif %}
                                            {% if report.grade %} • Grade {{ report.grade }}{% endif %}
                                             • {{ report.created_at|date:"M d, Y" }}
                                        </p>
                                    </div>
                                    {% if report.status == 'analyzed' %}
                                    <span class="px-2 py-1 bg-green-500/20 text-green-600 dark:text-green-400 rounded text-xs font-semibold">
                                        Analyzed
                                    </span>
                                    {% endif %}
                                </div>
                                {% if report.biomarkers %}
                                <div class="flex flex-wrap gap-1 mt-2">
                                    {% for key, value in report.biomarkers.items %}
                                    <span class="text-xs px-2 py-0.5 bg-primary/10 text-primary rounded">{{ key|upper }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Genomic Profiles -->
                {% if genomic_profiles %}
                <div class="bg-background/50 rounded-xl p-6 border border-border/30">
                    <h3 class="text-lg font-semibold text-foreground mb-4 flex items-center">
                        <i class="fas fa-dna text-purple-500 mr-2"></i>Genomic Profiles
                        <span class="ml-auto text-sm font-normal text-muted-foreground">{{ genomic_profiles.count }} available</span>
                    </h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for profile in genomic_profiles %}
                        <label class="flex items-start p-4 bg-card hover:bg-accent rounded-lg cursor-pointer border-2 border-transparent hover:border-primary/50 transition-all">
                            <input type="checkbox" name="genomic_profiles" value="{{ profile.id }}" 
                                class="mt-1 mr-3 rounded border-input text-primary focus:ring-primary">
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="font-semibold text-foreground">Genomic Profile - {{ profile.test_type|default:"NGS" }}</p>
                                        <p class="text-sm text-muted-foreground">{{ profile.created_at|date:"M d, Y" }}</p>
                                    </div>
                                    {% if profile.actionable_mutations %}
                                    <span class="px-2 py-1 bg-purple-500/20 text-purple-600 dark:text-purple-400 rounded text-xs font-semibold">
                                        {{ profile.actionable_mutations|length }} Actionable
                                    </span>
                                    {% endif %}
                                </div>
                                {% if profile.mutations %}
                                <div class="flex flex-wrap gap-1 mt-2">
                                    {% for mutation in profile.mutations|slice:":5" %}
                                    <span class="text-xs px-2 py-0.5 bg-purple-500/10 text-purple-600 dark:text-purple-400 rounded">{{ mutation }}</span>
                                    {% endfor %}
                                    {% if profile.mutations|length > 5 %}
                                    <span class="text-xs px-2 py-0.5 text-muted-foreground">+{{ profile.mutations|length|add:"-5" }} more</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Patient Information -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-foreground flex items-center">
                    <i class="fas fa-user text-primary mr-3"></i>Patient Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="age" class="block text-sm font-semibold text-foreground mb-2">
                            Age <span class="text-red-500">*</span>
                        </label>
                        <input type="number" name="age" id="age" min="1" max="120" required
                            class="w-full px-4 py-3 bg-background border border-input rounded-lg focus:ring-2 focus:ring-primary"
                            placeholder="e.g., 55">
                    </div>
                    <div>
                        <label for="sex" class="block text-sm font-semibold text-foreground mb-2">
                            Sex <span class="text-red-500">*</span>
                        </label>
                        <select name="sex" id="sex" required
                            class="w-full px-4 py-3 bg-background border border-input rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="performance_status" class="block text-sm font-semibold text-foreground mb-2">
                            Performance Status (ECOG) <span class="text-red-500">*</span>
                        </label>
                        <select name="performance_status" id="performance_status" required
                            class="w-full px-4 py-3 bg-background border border-input rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="0">0 - Fully active</option>
                            <option value="1" selected>1 - Restricted in strenuous activity</option>
                            <option value="2">2 - Ambulatory, self-care</option>
                            <option value="3">3 - Limited self-care</option>
                            <option value="4">4 - Completely disabled</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Comorbidities -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-foreground flex items-center">
                    <i class="fas fa-notes-medical text-orange-500 mr-2"></i>Medical History & Comorbidities
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for comorbidity in comorbidities_list %}
                    <label class="flex items-center space-x-2 cursor-pointer p-3 bg-background rounded-lg hover:bg-accent transition-colors">
                        <input type="checkbox" name="comorbidities" value="{{ comorbidity }}" 
                            class="rounded border-input text-primary focus:ring-primary">
                        <span class="text-sm text-foreground">{{ comorbidity }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- AI Generation Notice -->
            <div class="bg-blue-500/10 border-2 border-blue-500/50 rounded-xl p-6">
                <div class="flex items-start gap-4">
                    <i class="fas fa-robot text-blue-600 dark:text-blue-400 text-3xl"></i>
                    <div>
                        <h3 class="text-lg font-bold text-blue-700 dark:text-blue-300 mb-2">
                            AI-Powered Treatment Planning
                        </h3>
                        <p class="text-blue-700 dark:text-blue-300 text-sm leading-relaxed mb-3">
                            Your comprehensive treatment plan will be generated using advanced AI (Groq LLM) that analyzes:
                        </p>
                        <ul class="list-disc list-inside text-blue-700 dark:text-blue-300 text-sm space-y-1">
                            <li>All selected medical data sources (imaging, histopathology, genomics)</li>
                            <li>NCCN guidelines and current standard of care protocols</li>
                            <li>Evidence-based medicine and clinical trial data</li>
                            <li>Personalized factors including biomarkers and genetic mutations</li>
                        </ul>
                        <p class="text-xs text-blue-600 dark:text-blue-400 mt-3">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            This AI-generated plan is for informational purposes and should be reviewed with your oncology team.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex gap-4 pt-6 border-t border-border">
                <button type="submit" class="btn-primary flex-1 py-4 text-lg" id="submit-btn">
                    <i class="fas fa-brain mr-2"></i>Generate AI Treatment Plan
                    <i class="fas fa-spinner fa-spin ml-2 hidden" id="loading-icon"></i>
                </button>
                <a href="{% url 'cancer_detection:dashboard' %}" class="btn-secondary py-4 px-6">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('comprehensive-plan-form').addEventListener('submit', function() {
    const submitBtn = document.getElementById('submit-btn');
    const loadingIcon = document.getElementById('loading-icon');
    submitBtn.disabled = true;
    loadingIcon.classList.remove('hidden');
    submitBtn.innerHTML = '<i class="fas fa-brain mr-2"></i>Generating Plan... This may take 30-60 seconds <i class="fas fa-spinner fa-spin ml-2"></i>';
});
</script>
{% endblock %}

